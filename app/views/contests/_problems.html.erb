<% organizer = signed_in? && @contest.is_organized_by_or_admin(current_user) %>

<% @contest.contestproblems.order(:number).each do |p| %>
  <% can_see_statement = (organizer || p.at_least(:in_progress)) %>
  <% can_see_origin = (organizer || p.at_least(:in_correction)) %>
  <% if p.at_most(:not_started_yet) %>
    <% classe = "greyy" %>
  <% elsif p.in_progress? %>
    <% classe = "orangey" %>
  <% else %>
    <% classe = "yellowy" %>
  <% end %>
  
  <table class="table table-bordered problem <%= classe %>">
  <tr><td class="title">
  <center><h4>
  <% if can_see_statement && signed_in? %>
    <%= link_to "Problème ##{p.number}", p %>
    <% if current_user.root? && p.in_recorrection? %>
      (corrections modifiables)
    <% end %>
  <% else %>
     Problème #<%= p.number %>
  <% end %>
  </h4></center>
  </td></tr>
  
  <tr><td class="real-content">
  
  <div class="grid content"> <!-- 12 columns below 'md', 24 columns from 'md' (see module.scss) -->
  
    <div class="g-col-12 g-col-md-24 intro">
      <i>Solutions acceptées du <%= write_date_with_link(p.start_time, @contest, p) %> au <%= write_date_with_link(p.end_time, @contest, p) %> (heures belges).</i>
    </div>
    
    <% if can_see_statement %>        
      <div class="g-col-12 g-col-md-14 g-col-lg-16 g-col-xl-17 module left-part">
        <center><h5>Énoncé</h5></center>
        <%= htmlise(p.statement) %>
      </div>
      
      <div class="g-col-12 g-col-md-10 g-col-lg-8 g-col-xl-7 module right-part">
        <center><h5>Statistiques</h5></center>
        <% if p.at_least(:in_progress) %>
          <% sols = p.contestsolutions.where(:official => false).group(:corrected, :score).count %>
          <% nb_sol = sols.sum{|x| x.second} %>
          Tenté par <b><%= nb_sol %></b> personne<%= "s" if nb_sol > 1 %><br/>
          <% if p.at_least(:corrected) %>
            <% nb_perfect = sols[[true, 7]] %>
            <% nb_perfect = 0 if nb_perfect.nil? %>
            Scores parfaits : <b><%= nb_perfect %></b>
          <% elsif p.in_correction? %>
            En cours de correction
            <% if organizer %>
              <% nb_corrected = sols.sum{|x| (x.first[0] ? x.second : 0)} %>
              <% nb_partly_corrected = sols.sum{|x| (!x.first[0] && x.first[1] >= 0 ? x.second : 0)} %>
              <% nb_not_corrected = nb_sol - nb_corrected - nb_partly_corrected %>
              <% pct_corrected = (nb_corrected/nb_sol.to_f)*100 %>
              <% pct_partly_corrected = (nb_partly_corrected/nb_sol.to_f)*100 %>
              <% pct_not_corrected = (nb_not_corrected/nb_sol.to_f)*100 %>
              
              <div class="progress-stacked mx-4 mt-2">
                <% if nb_not_corrected > 0 %>
                  <div class="progress" role="progressbar" style="width: <%= pct_not_corrected %>%" aria-valuenow="<%= pct_not_corrected %>" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-danger"><%= nb_not_corrected if pct_not_corrected >= 12 %></div>
                  </div>
                <% end %>
                <% if nb_partly_corrected > 0 %>
                  <div class="progress" role="progressbar" style="width: <%= pct_partly_corrected %>%" aria-valuenow="<%= pct_partly_corrected %>" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-warning text-black"><%= nb_partly_corrected if pct_partly_corrected >= 12 %></div>
                  </div>
                <% end %>
                <% if nb_corrected > 0 %>
                  <div class="progress" role="progressbar" style="width: <%= pct_corrected %>%" aria-valuenow="<%= pct_corrected %>" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-success"><%= nb_corrected if pct_corrected >= 12 %></div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% end %>
    
    <% if p.at_most(:in_progress) && !@contest.in_construction? %>
      <% if p.at_most(:not_started_yet) %>
        <% date_limit = p.start_time.to_i %>
        <% message_before = "Publication dans" %>
        <% message_zero = "En ligne" %>
      <% else %>
        <% date_limit = p.end_time.to_i %>
        <% message_before = "Temps restant" %>
        <% message_zero = "Temps écoulé" %>
      <% end %>

      <div class="g-col-12 g-col-md-24 module clock-part">
        <%= render 'shared/clock', text: message_before, date_limit: date_limit, message_zero: message_zero, id: p.id %>
      </div>
    <% end %>
    
    <% if can_see_origin && !p.origin.nil? && p.origin != "" %>
      <div class="g-col-12 g-col-md-24 module bottom-part">
        Origine du problème : <b><%= p.origin %></b>
      </div>
    <% end %>
    
  </div>    
  </td></tr>
  </table>
<% end %>
